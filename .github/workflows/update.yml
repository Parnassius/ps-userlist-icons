name: update

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.setoutput.outputs.changed }}
    steps:
    - uses: actions/checkout@v3
    - name: Update files
      run: |
        wget -O pokemonicons-sheet.png https://play.pokemonshowdown.com/sprites/pokemonicons-sheet.png
        md5sum pokemonicons-sheet.png > pokemonicons-sheet.png.md5
        wget -O data.csv ${{ secrets.CSV_DATA_URL }}
    - name: Set output
      id: setoutput
      run: echo "::set-output name=changed::$( [[ "$(git status --porcelain)" ]] && echo -n 'true' )"

  build:
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.changed == 'true'
    steps:
    - uses: actions/checkout@v3
    - name: Clone pokemon showdown client
      uses: actions/checkout@v3
      with:
        repository: smogon/pokemon-showdown-client
        path: pokemon-showdown-client
    - name: Set up node
      uses: actions/setup-node@v3
      with:
        node-version: lts/*
    - name: Set up python
      uses: actions/setup-python@v4
      with:
        python-version: '*'
    - name: Build pokemon showdown client
      run: pokemon-showdown-client/build full
    - name: Update files
      run: |
        pip install Pillow
        wget -O pokemonicons-sheet.png https://play.pokemonshowdown.com/sprites/pokemonicons-sheet.png
        md5sum pokemonicons-sheet.png > pokemonicons-sheet.png.md5
        wget -O data.csv ${{ secrets.CSV_DATA_URL }}
        python offsets.py
        node run.js
    - name: Create commit
      run: |
        git config user.name 'prns'
        git config user.email '77806190+prnss@users.noreply.github.com'
        git commit -am "Update icons" && git push || true
